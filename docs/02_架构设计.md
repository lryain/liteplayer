# MusicPlayerEngine æ¶æ„è®¾è®¡æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-02-11  
**ä½œè€…**: GitHub Copilot

---

## 1. æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

åŸºäºliteplayerå¼€å‘ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„**MusicPlayerEngine**(åª’ä½“æ’­æ”¾å¼•æ“),æ»¡è¶³ä»¥ä¸‹éœ€æ±‚:

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… è‡ªåŠ¨æ‰«ææ–‡ä»¶å¤¹å¹¶å»ºç«‹æ’­æ”¾æ¸…å•
- âœ… åŠ¨æ€ç›‘æ§æ–‡ä»¶å˜åŒ–,è‡ªåŠ¨æ›´æ–°æ’­æ”¾æ¸…å•
- âœ… åŸºæœ¬æ’­æ”¾æ§åˆ¶(æ’­æ”¾ã€æš‚åœã€åœæ­¢ã€ä¸Šä¸€é¦–ã€ä¸‹ä¸€é¦–)
- âœ… å¤šç§æ’­æ”¾æ¨¡å¼(é¡ºåºã€å¾ªç¯ã€éšæœºã€å•æ›²å¾ªç¯)

**é«˜çº§åŠŸèƒ½**:
- ğŸ“ ID3æ ‡ç­¾è§£æ(æ­Œåã€è‰ºæœ¯å®¶ã€ä¸“è¾‘)
- ğŸ·ï¸ è‡ªå®šä¹‰æ ‡ç­¾ç³»ç»Ÿ(æµæ´¾ã€å¿ƒæƒ…ã€åœºæ™¯)
- ğŸ¯ æ ¹æ®æ ‡ç­¾ç­›é€‰å’Œæ’­æ”¾
- ğŸ’¡ æ’­æ”¾å†å²è®°å½•å’Œä¸ªæ€§åŒ–æ¨è
- â° å®šæ—¶æ’­æ”¾åŠŸèƒ½
- ğŸšï¸ éŸ³é¢‘å‡è¡¡å™¨(å¯é€‰,Phase 2)
- ğŸ“œ æ­Œè¯æ˜¾ç¤º(å¯é€‰,Phase 2)

**ç³»ç»Ÿé›†æˆ**:
- ğŸ”Œ åŸºäºZMQçš„æ§åˆ¶æ¥å£
- âš™ï¸ YAMLé…ç½®æ–‡ä»¶ç®¡ç†
- ğŸ“Š äº‹ä»¶å‘å¸ƒ(æ’­æ”¾çŠ¶æ€ã€è¿›åº¦ã€é”™è¯¯)
- ğŸš€ æœåŠ¡åŒ–éƒ¨ç½²

### 1.2 æŠ€æœ¯æ ˆ

- **æ ¸å¿ƒåº“**: liteplayer (Cè¯­è¨€)
- **åŒ…è£…å±‚**: C++ (MusicPlayerEngine)
- **å…ƒæ•°æ®**: taglib æˆ– libid3tag
- **æ•°æ®åº“**: SQLite3 (æ­Œæ›²ä¿¡æ¯ã€æ ‡ç­¾ã€å†å²)
- **æ¶ˆæ¯é˜Ÿåˆ—**: ZMQ (cppzmq)
- **é…ç½®**: yaml-cpp
- **æ–‡ä»¶ç›‘æ§**: inotify (Linux)
- **æ—¥å¿—**: spdlog

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Doly System (ZMQ Bus)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ daemon.py    â”‚  â”‚ eyeEngine    â”‚  â”‚ widget_srv   â”‚ ...  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚ ZMQ Pub/Sub                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”œâ”€â”€â”€ ZMQ Command â”€â”€â”€â”
          â””â”€â”€â”€ ZMQ Event   â”€â”€â”€â”¤
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        MusicPlayerEngine    â”‚                                â”‚
â”‚                             â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           ZMQControlInterface                        â”‚   â”‚
â”‚  â”‚  - Command Handler (SUB)                            â”‚   â”‚
â”‚  â”‚  - Event Publisher (PUB)                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           PlaybackController                        â”‚   â”‚
â”‚  â”‚  - State Machine                                    â”‚   â”‚
â”‚  â”‚  - Playback Control (play/pause/stop/next/prev)     â”‚   â”‚
â”‚  â”‚  - Progress Tracking                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           PlaylistManager                           â”‚   â”‚
â”‚  â”‚  - Playlist Storage (vector<Track>)                 â”‚   â”‚
â”‚  â”‚  - PlayMode (Sequential/Loop/Random/SingleLoop)     â”‚   â”‚
â”‚  â”‚  - Track Selection                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           MusicLibrary                              â”‚   â”‚
â”‚  â”‚  - SQLite Database                                  â”‚   â”‚
â”‚  â”‚  - Track Metadata (ID3)                             â”‚   â”‚
â”‚  â”‚  - Tag System                                       â”‚   â”‚
â”‚  â”‚  - Search & Filter                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           FileScanner                               â”‚   â”‚
â”‚  â”‚  - Directory Scanning                               â”‚   â”‚
â”‚  â”‚  - ID3 Tag Parsing                                  â”‚   â”‚
â”‚  â”‚  - File Monitor (inotify)                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           RecommendationEngine                      â”‚   â”‚
â”‚  â”‚  - Playback History                                 â”‚   â”‚
â”‚  â”‚  - Preference Learning                              â”‚   â”‚
â”‚  â”‚  - Recommendation Algorithm                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           LitePlayerWrapper                         â”‚   â”‚
â”‚  â”‚  - liteplayer C API Wrapper                         â”‚   â”‚
â”‚  â”‚  - State Callback Handler                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           liteplayer (C Library)                    â”‚   â”‚
â”‚  â”‚  - listplayer_handle_t                              â”‚   â”‚
â”‚  â”‚  - Audio Decoding (MP3/AAC/WAV/M4A)                 â”‚   â”‚
â”‚  â”‚  - ALSA Audio Output                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¨¡å—èŒè´£

#### 2.2.1 ZMQControlInterface (ZMQæ§åˆ¶æ¥å£)
- è®¢é˜…ZMQå‘½ä»¤æ¶ˆæ¯
- è§£æJSONæ ¼å¼çš„å‘½ä»¤
- è°ƒç”¨PlaybackControlleræ‰§è¡Œå‘½ä»¤
- å‘å¸ƒæ’­æ”¾äº‹ä»¶åˆ°ZMQæ€»çº¿

#### 2.2.2 PlaybackController (æ’­æ”¾æ§åˆ¶å™¨)
- ç®¡ç†æ’­æ”¾çŠ¶æ€æœº
- æ‰§è¡Œæ’­æ”¾æ§åˆ¶å‘½ä»¤
- è·Ÿè¸ªæ’­æ”¾è¿›åº¦
- å¤„ç†é”™è¯¯å’Œå¼‚å¸¸

#### 2.2.3 PlaylistManager (æ’­æ”¾åˆ—è¡¨ç®¡ç†å™¨)
- ç®¡ç†å½“å‰æ’­æ”¾åˆ—è¡¨
- å®ç°æ’­æ”¾æ¨¡å¼é€»è¾‘
- é€‰æ‹©ä¸‹ä¸€é¦–/ä¸Šä¸€é¦–æ›²ç›®
- æ”¯æŒåˆ—è¡¨æ“ä½œ(æ·»åŠ ã€åˆ é™¤ã€ç§»åŠ¨)

#### 2.2.4 MusicLibrary (éŸ³ä¹åº“)
- SQLiteæ•°æ®åº“ç®¡ç†
- æ›²ç›®å…ƒæ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢
- æ ‡ç­¾ç³»ç»Ÿå®ç°
- æœç´¢å’Œè¿‡æ»¤åŠŸèƒ½

#### 2.2.5 FileScanner (æ–‡ä»¶æ‰«æå™¨)
- æ‰«ææŒ‡å®šæ–‡ä»¶å¤¹
- è§£æID3æ ‡ç­¾
- ç›‘æ§æ–‡ä»¶å˜åŒ–(inotify)
- æ›´æ–°MusicLibrary

#### 2.2.6 RecommendationEngine (æ¨èå¼•æ“)
- è®°å½•æ’­æ”¾å†å²
- åˆ†æç”¨æˆ·åå¥½
- ç”Ÿæˆæ¨èåˆ—è¡¨

#### 2.2.7 LitePlayerWrapper (æ’­æ”¾å™¨åŒ…è£…å™¨)
- å°è£…liteplayer C API
- å¤„ç†çŠ¶æ€å›è°ƒ
- æä¾›C++å‹å¥½çš„æ¥å£

---

## 3. æ•°æ®æ¨¡å‹

### 3.1 æ•°æ®åº“è®¾è®¡ (SQLite)

#### tracks è¡¨ (æ›²ç›®ä¿¡æ¯)
```sql
CREATE TABLE tracks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    file_path TEXT UNIQUE NOT NULL,
    file_name TEXT NOT NULL,
    file_size INTEGER,
    file_mtime INTEGER,
    
    -- ID3 metadata
    title TEXT,
    artist TEXT,
    album TEXT,
    year INTEGER,
    genre TEXT,
    track_number INTEGER,
    duration INTEGER,  -- æ¯«ç§’
    
    -- ç»Ÿè®¡ä¿¡æ¯
    play_count INTEGER DEFAULT 0,
    skip_count INTEGER DEFAULT 0,
    last_played_at INTEGER,
    
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL
);

CREATE INDEX idx_tracks_artist ON tracks(artist);
CREATE INDEX idx_tracks_album ON tracks(album);
CREATE INDEX idx_tracks_genre ON tracks(genre);
```

#### tags è¡¨ (æ ‡ç­¾å®šä¹‰)
```sql
CREATE TABLE tags (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT UNIQUE NOT NULL,
    category TEXT,  -- 'genre', 'mood', 'scene', 'custom'
    color TEXT,     -- æ˜¾ç¤ºé¢œè‰²
    created_at INTEGER NOT NULL
);
```

#### track_tags è¡¨ (æ›²ç›®-æ ‡ç­¾å…³è”)
```sql
CREATE TABLE track_tags (
    track_id INTEGER NOT NULL,
    tag_id INTEGER NOT NULL,
    created_at INTEGER NOT NULL,
    PRIMARY KEY (track_id, tag_id),
    FOREIGN KEY (track_id) REFERENCES tracks(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
);
```

#### playlists è¡¨ (æ’­æ”¾åˆ—è¡¨)
```sql
CREATE TABLE playlists (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT UNIQUE NOT NULL,
    description TEXT,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL
);
```

#### playlist_tracks è¡¨ (æ’­æ”¾åˆ—è¡¨-æ›²ç›®å…³è”)
```sql
CREATE TABLE playlist_tracks (
    playlist_id INTEGER NOT NULL,
    track_id INTEGER NOT NULL,
    position INTEGER NOT NULL,  -- é¡ºåº
    PRIMARY KEY (playlist_id, track_id),
    FOREIGN KEY (playlist_id) REFERENCES playlists(id) ON DELETE CASCADE,
    FOREIGN KEY (track_id) REFERENCES tracks(id) ON DELETE CASCADE
);
```

#### play_history è¡¨ (æ’­æ”¾å†å²)
```sql
CREATE TABLE play_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    track_id INTEGER NOT NULL,
    played_at INTEGER NOT NULL,
    duration_played INTEGER,  -- å®é™…æ’­æ”¾æ—¶é•¿(æ¯«ç§’)
    completed BOOLEAN DEFAULT 0,  -- æ˜¯å¦æ’­æ”¾å®Œæˆ
    FOREIGN KEY (track_id) REFERENCES tracks(id) ON DELETE CASCADE
);

CREATE INDEX idx_play_history_track ON play_history(track_id);
CREATE INDEX idx_play_history_time ON play_history(played_at);
```

### 3.2 C++ æ•°æ®ç»“æ„

```cpp
// æ›²ç›®ä¿¡æ¯
struct Track {
    int64_t id;
    std::string file_path;
    std::string file_name;
    
    // Metadata
    std::string title;
    std::string artist;
    std::string album;
    int year;
    std::string genre;
    int track_number;
    int duration_ms;
    
    // Statistics
    int play_count;
    int skip_count;
    int64_t last_played_at;
    
    std::vector<std::string> tags;
};

// æ’­æ”¾æ¨¡å¼
enum class PlayMode {
    Sequential,      // é¡ºåºæ’­æ”¾
    LoopAll,        // åˆ—è¡¨å¾ªç¯
    Random,         // éšæœºæ’­æ”¾
    SingleLoop      // å•æ›²å¾ªç¯
};

// æ’­æ”¾çŠ¶æ€
enum class PlayState {
    Idle,
    Loading,
    Playing,
    Paused,
    Stopped,
    Error
};

// æ’­æ”¾åˆ—è¡¨
struct Playlist {
    int64_t id;
    std::string name;
    std::string description;
    std::vector<Track> tracks;
};
```

---

## 4. ZMQ æ¶ˆæ¯åè®®

### 4.1 æ¶ˆæ¯æ ¼å¼

æ‰€æœ‰æ¶ˆæ¯ä½¿ç”¨ **JSON** æ ¼å¼,é€šè¿‡ZMQ PUB/SUBæ¨¡å¼ä¼ è¾“ã€‚

#### æ¶ˆæ¯åœ°å€
- **å‘½ä»¤è®¢é˜…**: `tcp://localhost:5570` (SUB)
- **äº‹ä»¶å‘å¸ƒ**: `tcp://localhost:5571` (PUB)

æˆ–ä½¿ç”¨IPC:
- **å‘½ä»¤è®¢é˜…**: `ipc:///tmp/music_player_cmd.sock`
- **äº‹ä»¶å‘å¸ƒ**: `ipc:///tmp/music_player_event.sock`

#### è¯é¢˜ (Topic)
- `music.cmd.*` - å‘½ä»¤ç±»æ¶ˆæ¯
- `music.event.*` - äº‹ä»¶ç±»æ¶ˆæ¯

### 4.2 å‘½ä»¤æ¶ˆæ¯ (Commands)

#### 4.2.1 æ’­æ”¾æ§åˆ¶

**è¯é¢˜**: `music.cmd.control`

```json
{
    "cmd": "play",
    "params": {
        "track_id": 123  // å¯é€‰,ä¸æŒ‡å®šåˆ™æ’­æ”¾å½“å‰æ›²ç›®
    }
}
```

æ”¯æŒçš„å‘½ä»¤:
- `play` - æ’­æ”¾
- `pause` - æš‚åœ
- `resume` - ç»§ç»­
- `stop` - åœæ­¢
- `next` - ä¸‹ä¸€é¦–
- `prev` - ä¸Šä¸€é¦–
- `seek` - è·³è½¬
  ```json
  {"cmd": "seek", "params": {"position_ms": 30000}}
  ```

#### 4.2.2 æ’­æ”¾åˆ—è¡¨ç®¡ç†

**è¯é¢˜**: `music.cmd.playlist`

```json
{
    "cmd": "set_playlist",
    "params": {
        "playlist_id": 1
    }
}
```

æ”¯æŒçš„å‘½ä»¤:
- `set_playlist` - è®¾ç½®æ’­æ”¾åˆ—è¡¨
- `add_track` - æ·»åŠ æ›²ç›®
- `remove_track` - ç§»é™¤æ›²ç›®
- `clear` - æ¸…ç©ºåˆ—è¡¨
- `shuffle` - éšæœºæ‰“ä¹±

#### 4.2.3 æ’­æ”¾æ¨¡å¼

**è¯é¢˜**: `music.cmd.mode`

```json
{
    "cmd": "set_play_mode",
    "params": {
        "mode": "random"  // "sequential", "loop_all", "random", "single_loop"
    }
}
```

#### 4.2.4 æŸ¥è¯¢å‘½ä»¤

**è¯é¢˜**: `music.cmd.query`

```json
{
    "cmd": "search_tracks",
    "params": {
        "keyword": "å‘¨æ°ä¼¦",
        "fields": ["title", "artist", "album"]
    }
}
```

æ”¯æŒçš„æŸ¥è¯¢:
- `search_tracks` - æœç´¢æ›²ç›®
- `filter_by_tags` - æŒ‰æ ‡ç­¾ç­›é€‰
- `get_track_info` - è·å–æ›²ç›®ä¿¡æ¯
- `get_current_track` - è·å–å½“å‰æ›²ç›®
- `get_playlists` - è·å–æ‰€æœ‰æ’­æ”¾åˆ—è¡¨

#### 4.2.5 åº“ç®¡ç†

**è¯é¢˜**: `music.cmd.library`

```json
{
    "cmd": "scan_directory",
    "params": {
        "path": "/home/pi/Music"
    }
}
```

æ”¯æŒçš„å‘½ä»¤:
- `scan_directory` - æ‰«æç›®å½•
- `rescan_all` - é‡æ–°æ‰«ææ‰€æœ‰
- `update_metadata` - æ›´æ–°å…ƒæ•°æ®

#### 4.2.6 æ ‡ç­¾ç®¡ç†

**è¯é¢˜**: `music.cmd.tag`

```json
{
    "cmd": "add_tag_to_track",
    "params": {
        "track_id": 123,
        "tag": "relax"
    }
}
```

### 4.3 äº‹ä»¶æ¶ˆæ¯ (Events)

#### 4.3.1 æ’­æ”¾çŠ¶æ€å˜åŒ–

**è¯é¢˜**: `music.event.state`

```json
{
    "event": "state_changed",
    "timestamp": 1707680400,
    "data": {
        "state": "playing",  // "idle", "loading", "playing", "paused", "stopped", "error"
        "track_id": 123,
        "track_title": "ç¨»é¦™",
        "artist": "å‘¨æ°ä¼¦"
    }
}
```

#### 4.3.2 æ’­æ”¾è¿›åº¦

**è¯é¢˜**: `music.event.progress`

```json
{
    "event": "progress",
    "timestamp": 1707680400,
    "data": {
        "track_id": 123,
        "position_ms": 30000,
        "duration_ms": 240000,
        "percentage": 12.5
    }
}
```

#### 4.3.3 æ›²ç›®å˜åŒ–

**è¯é¢˜**: `music.event.track`

```json
{
    "event": "track_changed",
    "timestamp": 1707680400,
    "data": {
        "previous_track_id": 122,
        "current_track_id": 123,
        "track": {
            "title": "ç¨»é¦™",
            "artist": "å‘¨æ°ä¼¦",
            "album": "é­”æ°åº§",
            "duration_ms": 240000,
            "file_path": "/home/pi/Music/ç¨»é¦™.mp3"
        }
    }
}
```

#### 4.3.4 é”™è¯¯äº‹ä»¶

**è¯é¢˜**: `music.event.error`

```json
{
    "event": "error",
    "timestamp": 1707680400,
    "data": {
        "error_code": "FILE_NOT_FOUND",
        "error_message": "éŸ³é¢‘æ–‡ä»¶ä¸å­˜åœ¨",
        "track_id": 123
    }
}
```

#### 4.3.5 åº“æ›´æ–°äº‹ä»¶

**è¯é¢˜**: `music.event.library`

```json
{
    "event": "scan_completed",
    "timestamp": 1707680400,
    "data": {
        "tracks_added": 150,
        "tracks_updated": 10,
        "tracks_removed": 5,
        "duration_ms": 5000
    }
}
```

---

## 5. é…ç½®æ–‡ä»¶

### 5.1 é…ç½®æ–‡ä»¶è·¯å¾„

`config/music_player.yaml`

### 5.2 é…ç½®å†…å®¹

```yaml
# MusicPlayerEngine Configuration

# ZMQ é…ç½®
zmq:
  command_endpoint: "ipc:///tmp/music_player_cmd.sock"
  event_endpoint: "ipc:///tmp/music_player_event.sock"
  
# éŸ³ä¹åº“é…ç½®
library:
  database_path: "data/music_library.db"
  scan_directories:
    - "/home/pi/Music"
    - "/media/usb/Music"
  
  # æ–‡ä»¶æ ¼å¼æ”¯æŒ
  supported_formats: ["mp3", "m4a", "aac", "wav"]
  
  # è‡ªåŠ¨æ‰«æ
  auto_scan:
    enabled: true
    interval_seconds: 3600  # æ¯å°æ—¶æ‰«æä¸€æ¬¡
    watch_directories: true  # ä½¿ç”¨inotifyå®æ—¶ç›‘æ§
    
# æ’­æ”¾å™¨é…ç½®
player:
  # é»˜è®¤æ’­æ”¾æ¨¡å¼
  default_play_mode: "sequential"  # sequential, loop_all, random, single_loop
  
  # éŸ³é¢‘è¾“å‡º
  audio_output:
    device: "default"  # ALSAè®¾å¤‡å
    buffer_size: 4096
    
  # æ’­æ”¾è¿›åº¦æ›´æ–°é—´éš”(æ¯«ç§’)
  progress_update_interval: 1000
  
  # é¢„åŠ è½½ä¸‹ä¸€é¦–
  preload_next_track: true
  
# æ¨èå¼•æ“é…ç½®
recommendation:
  enabled: true
  
  # å†å²è®°å½•ä¿ç•™å¤©æ•°
  history_retention_days: 90
  
  # æ¨èç®—æ³•å‚æ•°
  algorithm:
    weight_play_count: 0.3
    weight_recent: 0.4
    weight_similar_tags: 0.3
    
# æ—¥å¿—é…ç½®
logging:
  level: "info"  # debug, info, warning, error
  file: "logs/music_player.log"
  max_size_mb: 100
  max_files: 5
  
# æœåŠ¡é…ç½®
service:
  name: "music-player"
  pid_file: "/var/run/music-player.pid"
  user: "pi"
  group: "pi"
```

---

## 6. çŠ¶æ€æœºè®¾è®¡

### 6.1 PlaybackController çŠ¶æ€æœº

```
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  IDLE   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜             â”‚
                  â”‚ load()           â”‚
                  â–¼                  â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
             â”‚ LOADING â”‚             â”‚
             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜             â”‚
          successâ”‚  â”‚error           â”‚
                  â–¼  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
        â”Œâ”€â”€â”€â–ºâ”‚ PLAYING â”‚             â”‚
        â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜             â”‚
        â”‚         â”‚ pause()          â”‚
        â”‚         â–¼                  â”‚
   resume()  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
        â”‚    â”‚ PAUSED  â”‚             â”‚
        â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜             â”‚
                  â”‚ stop()           â”‚
                  â–¼                  â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
             â”‚ STOPPED â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  ERROR  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                  â–²                  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 çŠ¶æ€è½¬æ¢è¡¨

| å½“å‰çŠ¶æ€ | äº‹ä»¶ | ç›®æ ‡çŠ¶æ€ | åŠ¨ä½œ |
|---------|------|---------|------|
| IDLE | load(track) | LOADING | åŠ è½½æ›²ç›® |
| LOADING | load_success | PLAYING | å¼€å§‹æ’­æ”¾ |
| LOADING | load_error | ERROR | è®°å½•é”™è¯¯ |
| PLAYING | pause() | PAUSED | æš‚åœæ’­æ”¾ |
| PLAYING | stop() | STOPPED | åœæ­¢æ’­æ”¾ |
| PLAYING | track_completed | IDLE/PLAYING | æ ¹æ®æ’­æ”¾æ¨¡å¼å†³å®š |
| PLAYING | error | ERROR | å¤„ç†é”™è¯¯ |
| PAUSED | resume() | PLAYING | ç»§ç»­æ’­æ”¾ |
| PAUSED | stop() | STOPPED | åœæ­¢æ’­æ”¾ |
| STOPPED | load(track) | LOADING | åŠ è½½æ–°æ›²ç›® |
| ERROR | reset() | IDLE | æ¸…é™¤é”™è¯¯ |

---

## 7. æ¥å£è®¾è®¡

### 7.1 MusicPlayerEngine ä¸»æ¥å£

```cpp
class MusicPlayerEngine {
public:
    MusicPlayerEngine(const std::string& config_path);
    ~MusicPlayerEngine();
    
    // åˆå§‹åŒ–å’Œå¯åŠ¨
    bool initialize();
    void start();
    void stop();
    
    // æ’­æ”¾æ§åˆ¶
    bool play(int64_t track_id = -1);
    bool pause();
    bool resume();
    bool stop();
    bool next();
    bool prev();
    bool seek(int position_ms);
    
    // æ’­æ”¾æ¨¡å¼
    void setPlayMode(PlayMode mode);
    PlayMode getPlayMode() const;
    
    // æ’­æ”¾åˆ—è¡¨
    bool setPlaylist(int64_t playlist_id);
    bool setPlaylist(const std::vector<int64_t>& track_ids);
    std::vector<Track> getCurrentPlaylist() const;
    
    // çŠ¶æ€æŸ¥è¯¢
    PlayState getState() const;
    Track getCurrentTrack() const;
    int getCurrentPosition() const;
    int getCurrentDuration() const;
    
    // åº“ç®¡ç†
    bool scanDirectory(const std::string& path);
    bool rescanAll();
    
    // æœç´¢å’Œè¿‡æ»¤
    std::vector<Track> searchTracks(const std::string& keyword);
    std::vector<Track> filterByTags(const std::vector<std::string>& tags);
    std::vector<Track> filterByArtist(const std::string& artist);
    std::vector<Track> filterByAlbum(const std::string& album);
    
    // æ¨è
    std::vector<Track> getRecommendations(int count = 10);
    
private:
    class Impl;
    std::unique_ptr<Impl> impl_;
};
```

---

## 8. å®ç°è®¡åˆ’

### Phase 1: åŸºç¡€æ¡†æ¶ (3å¤©)
- [x] liteplayer ç¼–è¯‘å’Œæµ‹è¯•
- [ ] é¡¹ç›®ç»“æ„æ­å»º
- [ ] CMakeLists.txt é…ç½®
- [ ] LitePlayerWrapper å®ç°
- [ ] åŸºç¡€æ’­æ”¾æ§åˆ¶æµ‹è¯•

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ (4å¤©)
- [ ] PlaybackController å®ç°
- [ ] PlaylistManager å®ç°
- [ ] æ’­æ”¾æ¨¡å¼é€»è¾‘
- [ ] çŠ¶æ€æœºå®Œæ•´å®ç°
- [ ] å•å…ƒæµ‹è¯•

### Phase 3: éŸ³ä¹åº“ (3å¤©)
- [ ] SQLite æ•°æ®åº“è®¾è®¡
- [ ] MusicLibrary å®ç°
- [ ] FileScanner å®ç°
- [ ] ID3 æ ‡ç­¾è§£æ(taglib)
- [ ] æœç´¢å’Œè¿‡æ»¤åŠŸèƒ½

### Phase 4: é«˜çº§åŠŸèƒ½ (3å¤©)
- [ ] æ ‡ç­¾ç³»ç»Ÿå®ç°
- [ ] æ–‡ä»¶ç›‘æ§(inotify)
- [ ] RecommendationEngine åŸºç¡€ç®—æ³•
- [ ] å®šæ—¶æ’­æ”¾åŠŸèƒ½

### Phase 5: ZMQé›†æˆ (3å¤©)
- [ ] ZMQControlInterface å®ç°
- [ ] æ¶ˆæ¯åºåˆ—åŒ–/ååºåˆ—åŒ–
- [ ] äº‹ä»¶å‘å¸ƒæœºåˆ¶
- [ ] å‘½ä»¤å¤„ç†é€»è¾‘
- [ ] é›†æˆæµ‹è¯•

### Phase 6: æµ‹è¯•å’Œæ–‡æ¡£ (2å¤©)
- [ ] å®Œæ•´çš„åŠŸèƒ½æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] ç”¨æˆ·æ‰‹å†Œ
- [ ] APIæ–‡æ¡£
- [ ] éƒ¨ç½²è„šæœ¬

**æ€»è®¡**: çº¦18å¤©

---

## 9. é£é™©å’ŒæŒ‘æˆ˜

### 9.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|-----|------|---------|
| liteplayerç¨³å®šæ€§é—®é¢˜ | é«˜ | å……åˆ†æµ‹è¯•,å‡†å¤‡å›é€€æ–¹æ¡ˆ |
| ID3æ ‡ç­¾è§£æå¤±è´¥ | ä¸­ | å®¹é”™å¤„ç†,ä¿å­˜æ–‡ä»¶åä½œä¸ºå¤‡ç”¨ |
| inotifyæ–‡ä»¶ç›‘æ§æ€§èƒ½ | ä¸­ | é™åˆ¶ç›‘æ§ç›®å½•æ•°é‡,æ‰¹é‡å¤„ç† |
| ZMQæ¶ˆæ¯ä¸¢å¤± | ä½ | ä½¿ç”¨å¯é æ¨¡å¼,æ·»åŠ å¿ƒè·³æœºåˆ¶ |

### 9.2 æ€§èƒ½è€ƒè™‘

- **å†…å­˜å ç”¨**: ç›®æ ‡ < 100MB
- **CPUå ç”¨**: æ’­æ”¾æ—¶ < 5%
- **å¯åŠ¨æ—¶é—´**: < 2ç§’
- **æ‰«ææ€§èƒ½**: 1000é¦–æ­Œ/ç§’

### 9.3 å…¼å®¹æ€§

- **Linux**: Raspberry Pi OS (ä¸»è¦ç›®æ ‡)
- **éŸ³é¢‘æ ¼å¼**: MP3, AAC, M4A, WAV
- **ID3ç‰ˆæœ¬**: v1, v2.3, v2.4
- **æ•°æ®åº“**: SQLite 3.x

---

## 10. åç»­æ‰©å±•

### Phase 2 åŠŸèƒ½ (å¯é€‰)

- ğŸšï¸ **éŸ³é¢‘å‡è¡¡å™¨**: é›†æˆLADSPAæ’ä»¶æˆ–è‡ªå®ç°
- ğŸ“œ **æ­Œè¯æ˜¾ç¤º**: LRCæ ¼å¼è§£æå’ŒåŒæ­¥
- ğŸ–¼ï¸ **ä¸“è¾‘å°é¢**: ä»ID3æå–æˆ–åœ¨çº¿è·å–
- ğŸ¤ **å¡æ‹‰OKæ¨¡å¼**: äººå£°æ¶ˆé™¤
- ğŸ“» **ç½‘ç»œç”µå°**: æ”¯æŒæµåª’ä½“URL
- â˜ï¸ **äº‘åŒæ­¥**: æ’­æ”¾åˆ—è¡¨å’Œå†å²äº‘åŒæ­¥
- ğŸ¨ **ä¸»é¢˜ç³»ç»Ÿ**: å¯å®šåˆ¶çš„UI(å¦‚æœæœ‰GUI)

---

**æœ¬æ–‡æ¡£å°†éšå¼€å‘è¿›åº¦æŒç»­æ›´æ–°**
