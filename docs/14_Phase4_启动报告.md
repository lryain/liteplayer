# Phase 4 å¯åŠ¨æŠ¥å‘Š - ZMQè¿œç¨‹æ§åˆ¶æ¥å£

> ğŸ“… å¯åŠ¨æ—¥æœŸï¼š2026-02-12  
> ğŸ“‹ çŠ¶æ€ï¼šğŸš€ **å‡†å¤‡å°±ç»ª**  
> ğŸ¯ ç›®æ ‡ï¼šå®ç°ZMQè¿œç¨‹æ§åˆ¶æ¥å£ï¼Œæ”¯æŒ26+å‘½ä»¤å’Œ6ç±»äº‹ä»¶

---

## ğŸ“Š Phase 4 æ¦‚è§ˆ

### æ ¸å¿ƒç›®æ ‡
å®ç°åŸºäºZMQçš„è¿œç¨‹æ§åˆ¶æœåŠ¡ï¼Œä½¿Doly daemonèƒ½å¤Ÿé€šè¿‡IPCé€šä¿¡æ§åˆ¶éŸ³ä¹æ’­æ”¾å™¨å¼•æ“ã€‚

### æ¶æ„è®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         ZMQ REQ/REP          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Doly Daemon    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ MusicPlayerServiceâ”‚
â”‚   (Client)      â”‚      ipc:///tmp/music_       â”‚    (Server)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      player_cmd.sock         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                           â”‚
                          ZMQ PUB/SUB                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  Doly Daemon    â”‚      ipc:///tmp/music_
â”‚  (Subscriber)   â”‚      player_event.sock
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                         æ§åˆ¶æµç¨‹
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ MusicPlayerServiceâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚           â”‚            â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚PlaybackCtrlâ”‚ â”‚MusicLibraryâ”‚ â”‚Playlist Mgrâ”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Phase 4 ç›®æ ‡æ¸…å•

### âœ… å‰ç½®å‡†å¤‡ï¼ˆå·²å®Œæˆï¼‰
- [x] Phase 3å®ŒæˆéªŒæ”¶ï¼ˆ100%æµ‹è¯•é€šè¿‡ï¼‰
- [x] é…ç½®æ–‡ä»¶å‡†å¤‡ï¼ˆmusic_player.yamlï¼‰
- [x] æ•°æ®åº“è·¯å¾„é…ç½®å®Œæˆ

### ğŸ“¦ ä¾èµ–å®‰è£…
- [ ] libzmq3-dev (ZMQæ ¸å¿ƒåº“)
- [ ] cppzmq-dev (C++ ZMQç»‘å®š)
- [ ] nlohmann-json3-dev (JSONè§£æ)

### ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶å¼€å‘
- [ ] MusicPlayerServiceç±»ï¼ˆZMQæœåŠ¡å™¨ï¼‰
- [ ] CommandHandlerï¼ˆå‘½ä»¤å¤„ç†å™¨ï¼‰
- [ ] EventPublisherï¼ˆäº‹ä»¶å‘å¸ƒå™¨ï¼‰
- [ ] ConfigLoaderï¼ˆé…ç½®åŠ è½½å™¨ï¼‰

### ğŸ”§ å‘½ä»¤å®ç°ï¼ˆ26+ä¸ªï¼‰
**æ’­æ”¾æ§åˆ¶ï¼ˆ9ä¸ªï¼‰**
- [ ] play - æ’­æ”¾å½“å‰æ›²ç›®
- [ ] pause - æš‚åœæ’­æ”¾
- [ ] resume - æ¢å¤æ’­æ”¾
- [ ] stop - åœæ­¢æ’­æ”¾
- [ ] next - ä¸‹ä¸€é¦–
- [ ] previous - ä¸Šä¸€é¦–
- [ ] seek - è·³è½¬åˆ°æŒ‡å®šä½ç½®
- [ ] set_volume - è®¾ç½®éŸ³é‡
- [ ] get_status - è·å–æ’­æ”¾çŠ¶æ€

**æ›²ç›®æŸ¥è¯¢ï¼ˆ8ä¸ªï¼‰**
- [ ] get_track - è·å–æ›²ç›®ä¿¡æ¯
- [ ] get_all_tracks - è·å–æ‰€æœ‰æ›²ç›®
- [ ] search_tracks - æœç´¢æ›²ç›®
- [ ] get_favorites - è·å–æ”¶è—åˆ—è¡¨
- [ ] get_recently_played - è·å–æœ€è¿‘æ’­æ”¾
- [ ] get_most_played - è·å–çƒ­é—¨æ›²ç›®
- [ ] get_by_artist - æŒ‰è‰ºæœ¯å®¶æŸ¥è¯¢
- [ ] get_by_album - æŒ‰ä¸“è¾‘æŸ¥è¯¢

**æ’­æ”¾åˆ—è¡¨ï¼ˆ6ä¸ªï¼‰**
- [ ] create_playlist - åˆ›å»ºæ’­æ”¾åˆ—è¡¨
- [ ] delete_playlist - åˆ é™¤æ’­æ”¾åˆ—è¡¨
- [ ] get_playlists - è·å–æ‰€æœ‰æ’­æ”¾åˆ—è¡¨
- [ ] add_to_playlist - æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨
- [ ] remove_from_playlist - ä»æ’­æ”¾åˆ—è¡¨ç§»é™¤
- [ ] get_playlist_tracks - è·å–æ’­æ”¾åˆ—è¡¨æ›²ç›®

**åº“ç®¡ç†ï¼ˆ3ä¸ªï¼‰**
- [ ] add_track - æ·»åŠ æ›²ç›®
- [ ] update_track - æ›´æ–°æ›²ç›®
- [ ] delete_track - åˆ é™¤æ›²ç›®
- [ ] scan_directory - æ‰«æç›®å½•

### ğŸ“¢ äº‹ä»¶å‘å¸ƒï¼ˆ6ç±»ï¼‰
- [ ] **çŠ¶æ€äº‹ä»¶**: playing, paused, stopped
- [ ] **æ›²ç›®äº‹ä»¶**: track_changed, track_ended
- [ ] **è¿›åº¦äº‹ä»¶**: progress_update
- [ ] **æ’­æ”¾åˆ—è¡¨äº‹ä»¶**: playlist_created, playlist_updated, playlist_deleted
- [ ] **åº“äº‹ä»¶**: track_added, track_updated, track_deleted
- [ ] **é”™è¯¯äº‹ä»¶**: playback_error, library_error

### ğŸ§ª æµ‹è¯•éªŒè¯
- [ ] å•å…ƒæµ‹è¯•ï¼ˆå‘½ä»¤å¤„ç†ï¼‰
- [ ] é›†æˆæµ‹è¯•ï¼ˆZMQé€šä¿¡ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆå¹¶å‘å‘½ä»¤ï¼‰
- [ ] æ¨¡æ‹Ÿå®¢æˆ·ç«¯æµ‹è¯•

---

## ğŸ“‹ å®æ–½è®¡åˆ’

### ç¬¬1æ­¥ï¼šç¯å¢ƒå‡†å¤‡ï¼ˆé¢„è®¡1å°æ—¶ï¼‰
```bash
# 1. å®‰è£…ZMQä¾èµ–
sudo apt-get update
sudo apt-get install -y libzmq3-dev cppzmq-dev nlohmann-json3-dev

# 2. åˆ›å»ºæ•°æ®åº“ç›®å½•
mkdir -p /home/pi/.local/share/music-player/backups

# 3. éªŒè¯å®‰è£…
pkg-config --modversion libzmq
dpkg -l | grep nlohmann
```

### ç¬¬2æ­¥ï¼šé…ç½®åŠ è½½å™¨ï¼ˆé¢„è®¡2å°æ—¶ï¼‰
**æ–‡ä»¶**: `engine/include/ConfigLoader.h`, `engine/src/service/ConfigLoader.cpp`

**åŠŸèƒ½**:
- åŠ è½½YAMLé…ç½®æ–‡ä»¶
- è§£æZMQç«¯ç‚¹é…ç½®
- è§£ææ•°æ®åº“è·¯å¾„
- æä¾›é…ç½®è®¿é—®æ¥å£

**ä»£ç é‡**: ~200è¡Œ

### ç¬¬3æ­¥ï¼šJSONåè®®å®šä¹‰ï¼ˆé¢„è®¡1å°æ—¶ï¼‰
**æ–‡ä»¶**: `engine/include/JsonProtocol.h`

**æ¶ˆæ¯æ ¼å¼**:
```json
// å‘½ä»¤è¯·æ±‚
{
  "command": "play",
  "params": {
    "track_id": 123
  },
  "request_id": "uuid-1234"
}

// å‘½ä»¤å“åº”
{
  "status": "success",
  "result": {
    "playing": true,
    "track_id": 123
  },
  "request_id": "uuid-1234"
}

// äº‹ä»¶å‘å¸ƒ
{
  "event": "track_changed",
  "data": {
    "track_id": 123,
    "title": "Song Name",
    "artist": "Artist Name"
  },
  "timestamp": 1707734400
}
```

### ç¬¬4æ­¥ï¼šMusicPlayerServiceæ ¸å¿ƒï¼ˆé¢„è®¡4å°æ—¶ï¼‰
**æ–‡ä»¶**: `engine/include/MusicPlayerService.h`, `engine/src/service/MusicPlayerService.cpp`

**æ ¸å¿ƒåŠŸèƒ½**:
- ZMQ REQ/REPæœåŠ¡å™¨ï¼ˆå‘½ä»¤æ¥æ”¶ï¼‰
- ZMQ PUBå‘å¸ƒå™¨ï¼ˆäº‹ä»¶å‘å¸ƒï¼‰
- å‘½ä»¤è·¯ç”±å’Œåˆ†å‘
- çº¿ç¨‹å®‰å…¨çš„çŠ¶æ€ç®¡ç†

**ä»£ç é‡**: ~400è¡Œ

### ç¬¬5æ­¥ï¼šå‘½ä»¤å¤„ç†å™¨ï¼ˆé¢„è®¡6å°æ—¶ï¼‰
**æ–‡ä»¶**: `engine/src/service/CommandHandler.cpp`

**å®ç°ç­–ç•¥**:
- å‘½ä»¤æ³¨å†Œè¡¨ï¼ˆstd::map<string, CommandFunc>ï¼‰
- ç»Ÿä¸€é”™è¯¯å¤„ç†
- å‚æ•°éªŒè¯
- è¿”å›å€¼æ ‡å‡†åŒ–

**ä»£ç é‡**: ~600è¡Œï¼ˆ26+å‘½ä»¤ï¼‰

### ç¬¬6æ­¥ï¼šäº‹ä»¶å‘å¸ƒå™¨ï¼ˆé¢„è®¡3å°æ—¶ï¼‰
**æ–‡ä»¶**: `engine/src/service/EventPublisher.cpp`

**åŠŸèƒ½**:
- äº‹ä»¶é˜Ÿåˆ—ç®¡ç†
- å¼‚æ­¥å‘å¸ƒæœºåˆ¶
- è®¢é˜…è€…ç®¡ç†
- äº‹ä»¶è¿‡æ»¤

**ä»£ç é‡**: ~250è¡Œ

### ç¬¬7æ­¥ï¼šä¸»ç¨‹åºï¼ˆé¢„è®¡2å°æ—¶ï¼‰
**æ–‡ä»¶**: `engine/src/music_player_server.cpp`

**åŠŸèƒ½**:
- æœåŠ¡åˆå§‹åŒ–
- ä¿¡å·å¤„ç†ï¼ˆSIGINT, SIGTERMï¼‰
- é…ç½®åŠ è½½
- æ—¥å¿—åˆå§‹åŒ–
- ä¸»å¾ªç¯

**ä»£ç é‡**: ~150è¡Œ

### ç¬¬8æ­¥ï¼šæµ‹è¯•å¥—ä»¶ï¼ˆé¢„è®¡4å°æ—¶ï¼‰
**æ–‡ä»¶**: `engine/tests/test_service.cpp`, `scripts/test_client.py`

**æµ‹è¯•å†…å®¹**:
- å‘½ä»¤å“åº”æµ‹è¯•
- äº‹ä»¶è®¢é˜…æµ‹è¯•
- å¹¶å‘è¯·æ±‚æµ‹è¯•
- é”™è¯¯å¤„ç†æµ‹è¯•

**ä»£ç é‡**: ~500è¡Œ

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
3rd/liteplayer/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ music_player.yaml        âœ… å·²å®Œæˆï¼ˆæ·»åŠ æ•°æ®åº“é…ç½®ï¼‰
â”œâ”€â”€ engine/
â”‚   â”œâ”€â”€ include/
â”‚   â”‚   â”œâ”€â”€ ConfigLoader.h       â³ å¾…åˆ›å»º
â”‚   â”‚   â”œâ”€â”€ JsonProtocol.h       â³ å¾…åˆ›å»º
â”‚   â”‚   â”œâ”€â”€ MusicPlayerService.h â³ å¾…åˆ›å»º
â”‚   â”‚   â”œâ”€â”€ CommandHandler.h     â³ å¾…åˆ›å»º
â”‚   â”‚   â””â”€â”€ EventPublisher.h     â³ å¾…åˆ›å»º
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”‚   â”œâ”€â”€ ConfigLoader.cpp       â³ å¾…åˆ›å»º
â”‚   â”‚   â”‚   â”œâ”€â”€ MusicPlayerService.cpp â³ å¾…åˆ›å»º
â”‚   â”‚   â”‚   â”œâ”€â”€ CommandHandler.cpp     â³ å¾…åˆ›å»º
â”‚   â”‚   â”‚   â””â”€â”€ EventPublisher.cpp     â³ å¾…åˆ›å»º
â”‚   â”‚   â””â”€â”€ music_player_server.cpp    â³ å¾…åˆ›å»ºï¼ˆä¸»ç¨‹åºï¼‰
â”‚   â””â”€â”€ tests/
â”‚       â””â”€â”€ test_service.cpp     â³ å¾…åˆ›å»º
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ test_client.py           â³ å¾…åˆ›å»ºï¼ˆPythonæµ‹è¯•å®¢æˆ·ç«¯ï¼‰
â”‚   â””â”€â”€ install_deps.sh          â³ å¾…åˆ›å»ºï¼ˆä¾èµ–å®‰è£…è„šæœ¬ï¼‰
â””â”€â”€ docs/
    â”œâ”€â”€ 14_Phase4_å¯åŠ¨æŠ¥å‘Š.md    âœ… æœ¬æ–‡æ¡£
    â”œâ”€â”€ 15_Phase4_APIæ–‡æ¡£.md     â³ å¾…åˆ›å»º
    â””â”€â”€ 16_Phase4_æµ‹è¯•æŒ‡å—.md    â³ å¾…åˆ›å»º
```

---

## ğŸ“Š é¢„è®¡å·¥ä½œé‡

| ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | ä»£ç é‡ |
|------|---------|--------|
| ç¯å¢ƒå‡†å¤‡ | 1å°æ—¶ | - |
| ConfigLoader | 2å°æ—¶ | ~200è¡Œ |
| JSONåè®®å®šä¹‰ | 1å°æ—¶ | ~100è¡Œ |
| MusicPlayerService | 4å°æ—¶ | ~400è¡Œ |
| CommandHandler | 6å°æ—¶ | ~600è¡Œ |
| EventPublisher | 3å°æ—¶ | ~250è¡Œ |
| ä¸»ç¨‹åº | 2å°æ—¶ | ~150è¡Œ |
| æµ‹è¯•å¥—ä»¶ | 4å°æ—¶ | ~500è¡Œ |
| **æ€»è®¡** | **23å°æ—¶** | **~2200è¡Œ** |

---

## ğŸ”§ æŠ€æœ¯æ ˆ

### æ ¸å¿ƒåº“
- **ZMQ 4.3+**: æ¶ˆæ¯é˜Ÿåˆ—å’ŒIPCé€šä¿¡
- **nlohmann/json**: JSONåºåˆ—åŒ–/ååºåˆ—åŒ–
- **yaml-cpp**: YAMLé…ç½®è§£æï¼ˆå¯é€‰ï¼‰
- **SQLite3**: æ•°æ®åº“ï¼ˆå·²æœ‰ï¼‰
- **liteplayer**: éŸ³é¢‘æ’­æ”¾ï¼ˆå·²æœ‰ï¼‰

### è®¾è®¡æ¨¡å¼
- **Command Pattern**: å‘½ä»¤å¤„ç†
- **Observer Pattern**: äº‹ä»¶å‘å¸ƒè®¢é˜…
- **Singleton Pattern**: æœåŠ¡å®ä¾‹ç®¡ç†
- **Factory Pattern**: å‘½ä»¤åˆ›å»º

### çº¿ç¨‹æ¨¡å‹
```
Main Thread
    â”‚
    â”œâ”€â–º ZMQ REQ/REP Thread (å‘½ä»¤æ¥æ”¶)
    â”‚
    â”œâ”€â–º ZMQ PUB Thread (äº‹ä»¶å‘å¸ƒ)
    â”‚
    â””â”€â–º Playback Thread (éŸ³é¢‘æ’­æ”¾ï¼Œå·²æœ‰)
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] æ‰€æœ‰26+å‘½ä»¤æ­£ç¡®å“åº”
- [ ] æ‰€æœ‰6ç±»äº‹ä»¶æ­£ç¡®å‘å¸ƒ
- [ ] ZMQé€šä¿¡ç¨³å®šï¼ˆæ— æ¶ˆæ¯ä¸¢å¤±ï¼‰
- [ ] å¹¶å‘è¯·æ±‚å¤„ç†æ­£ç¡®
- [ ] é”™è¯¯å¤„ç†å®Œå–„

### æ€§èƒ½éªŒæ”¶
- [ ] å‘½ä»¤å“åº”æ—¶é—´ < 100ms
- [ ] äº‹ä»¶å‘å¸ƒå»¶è¿Ÿ < 50ms
- [ ] æ”¯æŒ10+å¹¶å‘å®¢æˆ·ç«¯
- [ ] å†…å­˜å ç”¨ < 50MB

### è´¨é‡éªŒæ”¶
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡ç‡ 100%
- [ ] æ— å†…å­˜æ³„æ¼
- [ ] æ— çº¿ç¨‹å®‰å…¨é—®é¢˜

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¼€å§‹
1. **å®‰è£…ä¾èµ–**
   ```bash
   cd /home/pi/dev/nora-xiaozhi-dev/3rd/liteplayer
   sudo apt-get install -y libzmq3-dev cppzmq-dev nlohmann-json3-dev
   ```

2. **åˆ›å»ºç›®å½•ç»“æ„**
   ```bash
   mkdir -p engine/src/service
   mkdir -p scripts
   mkdir -p /home/pi/.local/share/music-player/backups
   ```

3. **å¼€å§‹ç¬¬ä¸€ä¸ªç»„ä»¶ï¼šConfigLoader**
   - åˆ›å»º `engine/include/ConfigLoader.h`
   - åˆ›å»º `engine/src/service/ConfigLoader.cpp`
   - æ·»åŠ åˆ°CMakeLists.txt

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

### ZMQæ–‡æ¡£
- [ZeroMQ Guide](http://zguide.zeromq.org/)
- [cppzmq Examples](https://github.com/zeromq/cppzmq)

### JSONæ–‡æ¡£
- [nlohmann/json README](https://github.com/nlohmann/json)

### å·²æœ‰Phase 3æ–‡æ¡£
- `docs/10_Phase3_å®ŒæˆæŠ¥å‘Š.md` - æ•°æ®åº“APIå‚è€ƒ
- `docs/13_Phase3_éªŒæ”¶æŠ¥å‘Š.md` - CRUDæ“ä½œç¤ºä¾‹

---

**âœ… Phase 4 å‡†å¤‡å®Œæˆï¼Œéšæ—¶å¯ä»¥å¼€å§‹å¼€å‘ï¼** ğŸš€

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2026-02-12*  
*å½“å‰çŠ¶æ€: é…ç½®å®Œæˆï¼Œç­‰å¾…ä¾èµ–å®‰è£…*  
*ä¸‹ä¸€æ­¥: å®‰è£…ZMQä¾èµ–å¹¶åˆ›å»ºConfigLoader*
